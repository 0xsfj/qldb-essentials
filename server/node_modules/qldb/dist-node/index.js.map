{"version":3,"file":"index.js","sources":["../dist-src/index.js"],"sourcesContent":["\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.compare = compare;\nexports.ionize = ionize;\nexports.toIonText = toIonText;\nexports.default = void 0;\n\nvar _lodash = require(\"lodash\");\n\nvar _awsSdk = require(\"aws-sdk\");\n\nvar _amazonQldbDriverNodejs = require(\"amazon-qldb-driver-nodejs\");\n\nvar _ionJs = require(\"ion-js\");\n\nvar _crypto = require(\"crypto\");\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nconst HASH_LENGTH = 32;\n/* eslint-disable */\n\nfunction parseProof(valueHolder) {\n  let proofList = valueHolder.IonText;\n  const r = (0, _ionJs.makeReader)(proofList);\n  r.next();\n  r.stepIn();\n  proofList = proofList.replace(']', '');\n  proofList = proofList.replace('[', '');\n  const array = proofList.split(',');\n  const byteArray = [];\n\n  for (let i = 0; i < array.length; i++) {\n    r.next();\n    byteArray.push(r.byteValue());\n  }\n\n  return byteArray;\n}\n\nfunction compareHashValues(hash1, hash2) {\n  if (hash1.length !== HASH_LENGTH || hash2.length !== HASH_LENGTH) {\n    throw new Error('Invalid hash.');\n  }\n\n  for (let i = hash1.length - 1; i >= 0; i--) {\n    const difference = (hash1[i] << 24 >> 24) - (hash2[i] << 24 >> 24);\n\n    if (difference !== 0) {\n      return difference;\n    }\n  }\n\n  return 0;\n}\n\nfunction concatenate(...arrays) {\n  let totalLength = 0;\n\n  for (const arr of arrays) {\n    totalLength += arr.length;\n  }\n\n  const result = new Uint8Array(totalLength);\n  let offset = 0;\n\n  for (const arr of arrays) {\n    result.set(arr, offset);\n    offset += arr.length;\n  }\n\n  return result;\n}\n\nfunction joinHashesPairwise(h1, h2) {\n  if (h1.length === 0) {\n    return h2;\n  }\n\n  if (h2.length === 0) {\n    return h1;\n  }\n\n  let concat;\n\n  if (compareHashValues(h1, h2) < 0) {\n    concat = concatenate(h1, h2);\n  } else {\n    concat = concatenate(h2, h1);\n  }\n\n  const hash = (0, _crypto.createHash)('sha256');\n  hash.update(concat);\n  const newDigest = hash.digest();\n  return newDigest;\n}\n/* eslint-enable */\n\n\nfunction calculateRootHashFromInternalHash(internalHashes, leafHash) {\n  return internalHashes.reduce(joinHashesPairwise, leafHash);\n}\n\nfunction buildCandidateDigest(proof, leafHash) {\n  const parsedProof = parseProof(proof);\n  const rootHash = calculateRootHashFromInternalHash(parsedProof, leafHash);\n  return rootHash;\n}\n\nfunction compare(documentHash, digest, proof) {\n  const candidateDigest = buildCandidateDigest(proof, documentHash);\n  return (0, _ionJs.toBase64)(digest) === (0, _ionJs.toBase64)(candidateDigest);\n}\n\nfunction ionize(entity) {\n  let string = '';\n\n  if ((0, _lodash.isPlainObject)(entity)) {\n    Object.entries(entity).forEach(([key, value]) => {\n      if ((0, _lodash.isDate)(value)) {\n        string += `'${key}':\\`${value.toISOString()}\\`,`;\n      } else if ((0, _lodash.isPlainObject)(value)) {\n        string += `'${key}':${ionize(value)},`;\n      } else if ((0, _lodash.isArray)(value)) {\n        string += `'${key}':[${value.map(v => ionize(v)).join(',')}],`;\n      } else {\n        string += `'${key}':${JSON.stringify(value).replace(/\"/ig, \"'\")},`;\n      }\n    });\n    string = `{${string.slice(0, -1)}}`;\n  } else if ((0, _lodash.isArray)(entity)) {\n    string = `<<${entity.map(e => ionize(e)).join(',')}>>`;\n  } else {\n    string = JSON.stringify(entity).replace(/\"/ig, \"'\");\n  }\n\n  return string;\n}\n\nfunction toIonText({\n  strandId,\n  sequenceNo\n} = {}) {\n  return {\n    IonText: `{strandId: \"${strandId}\", sequenceNo: ${sequenceNo}}`\n  };\n}\n\nclass QLDB {\n  constructor(props = {}) {\n    _defineProperty(this, \"parseIon\", ion => {\n      if (ion.type() === null) {\n        ion.next();\n      }\n\n      if (ion.type() === _ionJs.IonTypes.LIST) {\n        const list = [];\n        ion.stepIn();\n\n        while (ion.next() != null) {\n          const itemInList = this.parseIon(ion);\n          list.push(itemInList);\n        }\n\n        return list;\n      }\n\n      if (ion.type() === _ionJs.IonTypes.STRUCT) {\n        const structToReturn = {};\n        let type;\n        const currentDepth = ion.depth();\n        ion.stepIn();\n\n        while (ion.depth() > currentDepth) {\n          type = ion.next();\n\n          if (type === null) {\n            ion.stepOut();\n          } else {\n            structToReturn[ion.fieldName()] = this.parseIon(ion);\n          }\n        }\n\n        return structToReturn;\n      }\n\n      if (ion.type().isNumeric) {\n        return ion.numberValue();\n      }\n\n      if (ion.type() === _ionJs.IonTypes.DECIMAL) {\n        return ion.value().numberValue();\n      }\n\n      if (ion.type() === _ionJs.IonTypes.TIMESTAMP) {\n        return ion.value().toString();\n      }\n\n      return ion.value();\n    });\n\n    this.props = _objectSpread({\n      region: 'us-east-2',\n      controlProps: {},\n      sessionProps: {}\n    }, props);\n    this.control = new _awsSdk.QLDB(_objectSpread({\n      accessKeyId: this.props.accessKey,\n      secretAccessKey: this.props.secretKey,\n      region: this.props.region\n    }, this.props.controlProps));\n\n    if (this.props.ledger) {\n      this.connect(this.props.ledger);\n    }\n  } // TABLE CRUD\n  // https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/QLDB.html#createLedger-property\n\n\n  create(props) {\n    return this.control.createLedger(props).promise();\n  } // https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/QLDB.html#deleteLedger-property\n\n\n  delete(props) {\n    return this.control.deleteLedger(props).promise();\n  } // https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/QLDB.html#listLedgers-property\n\n\n  list(props) {\n    return this.control.listLedgers(props).promise();\n  } // https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/QLDB.html#describeLedger-property\n\n\n  describe(props) {\n    return this.control.describeLedger(props).promise();\n  } // https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/QLDB.html#updateLedger-property\n\n\n  update(props) {\n    return this.control.describeLedger(props).promise();\n  } // BLOCKCHAIN\n  // https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/QLDB.html#getBlock-property\n\n\n  block(props) {\n    return this.control.getBlock(props).promise();\n  } // https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/QLDB.html#getDigest-property\n\n\n  digest(props) {\n    return this.control.getDigest(props).promise();\n  } // https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/QLDB.html#getRevision-property\n\n\n  revision(props) {\n    return this.control.getRevision(props).promise();\n  } // JOURNALS\n  // https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/QLDB.html#describeJournalS3Export-property\n\n\n  journal(props) {\n    return this.control.describeJournalS3Export(props).promise();\n  } // https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/QLDB.html#exportJournalToS3-property\n\n\n  exportJournal(props) {\n    return this.control.exportJournalToS3(props).promise();\n  } // https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/QLDB.html#listJournalS3Exports-property\n  // https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/QLDB.html#listJournalS3ExportsForLedger-property\n\n\n  listJournals(props = {}) {\n    if (!props.Name) return this.control.listJournalS3Exports(props).promise();\n    return this.control.listJournalS3ExportsForLedger(props).promise();\n  } // TODO: TAGS\n  // EXECUTION\n\n\n  connect(ledger, sessionProps) {\n    if (this.sessionDriver) {\n      this.sessionDriver.close();\n    }\n\n    this.sessionDriver = new _amazonQldbDriverNodejs.PooledQldbDriver(ledger, _objectSpread({\n      accessKeyId: this.props.accessKey,\n      secretAccessKey: this.props.secretKey,\n      region: this.props.region\n    }, sessionProps || this.props.sessionProps));\n  }\n\n  async session() {\n    if (!this.sessionDriver) throw new Error('The driver is not connected to a ledger! Use .connect(ledgerName) before running queries');\n    return this.sessionDriver.getSession();\n  }\n\n  async execute(query, ops = {}) {\n    const {\n      noParse = false,\n      txn\n    } = ops;\n    let binaryResult;\n\n    if (txn) {\n      binaryResult = await txn.executeInline(query);\n    } else {\n      const session = await this.session();\n      binaryResult = await session.executeStatement(query);\n    }\n\n    const resultList = binaryResult.getResultList();\n    if (noParse) return resultList;\n    return this.parse(resultList);\n  }\n\n  async transaction(fn = () => {}) {\n    const session = await this.session();\n    return session.executeLambda(txn => fn({\n      txn,\n      execute: (query, ops) => this.execute(query, _objectSpread({}, ops, {\n        txn\n      }))\n    }));\n  }\n\n  parse(ions) {\n    return ions.map(this.parseIon);\n  }\n\n  async validate(query) {\n    const digest = await this.digest({\n      Name: this.props.ledger\n    });\n    const docs = await this.execute(query);\n    const doc = docs[0];\n    if (!doc) throw new Error('Datum not found!');\n    const revision = await this.revision({\n      Name: this.props.ledger,\n      BlockAddress: toIonText(doc.blockAddress),\n      DigestTipAddress: digest.DigestTipAddress,\n      DocumentId: doc.metadata.id\n    });\n    return compare(doc.hash, digest.Digest, revision.Proof);\n  }\n\n}\n\nexports.default = QLDB;"],"names":["Object","defineProperty","exports","value","compare","ionize","toIonText","default","_lodash","require","_awsSdk","_amazonQldbDriverNodejs","_ionJs","_crypto","ownKeys","object","enumerableOnly","keys","getOwnPropertySymbols","symbols","filter","sym","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","target","i","arguments","length","source","forEach","key","_defineProperty","getOwnPropertyDescriptors","defineProperties","obj","configurable","writable","HASH_LENGTH","parseProof","valueHolder","proofList","IonText","r","makeReader","next","stepIn","replace","array","split","byteArray","byteValue","compareHashValues","hash1","hash2","Error","difference","concatenate","arrays","totalLength","arr","result","Uint8Array","offset","set","joinHashesPairwise","h1","h2","concat","hash","createHash","update","newDigest","digest","calculateRootHashFromInternalHash","internalHashes","leafHash","reduce","buildCandidateDigest","proof","parsedProof","rootHash","documentHash","candidateDigest","toBase64","entity","string","isPlainObject","entries","isDate","toISOString","isArray","map","v","join","JSON","stringify","slice","e","strandId","sequenceNo","QLDB","constructor","props","ion","type","IonTypes","LIST","list","itemInList","parseIon","STRUCT","structToReturn","currentDepth","depth","stepOut","fieldName","isNumeric","numberValue","DECIMAL","TIMESTAMP","toString","region","controlProps","sessionProps","control","accessKeyId","accessKey","secretAccessKey","secretKey","ledger","connect","create","createLedger","promise","delete","deleteLedger","listLedgers","describe","describeLedger","block","getBlock","getDigest","revision","getRevision","journal","describeJournalS3Export","exportJournal","exportJournalToS3","listJournals","Name","listJournalS3Exports","listJournalS3ExportsForLedger","sessionDriver","close","PooledQldbDriver","session","getSession","execute","query","ops","noParse","txn","binaryResult","executeInline","executeStatement","resultList","getResultList","parse","transaction","fn","executeLambda","ions","validate","docs","doc","BlockAddress","blockAddress","DigestTipAddress","DocumentId","metadata","id","Digest","Proof"],"mappings":"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"}